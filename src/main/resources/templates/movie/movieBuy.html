<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<<<<<<< HEAD
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!-- jQuery -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
        <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <th:block th:replace="~{/include/layout :: setContent( ~{:: .buy} ) }">
    <div class="buy">
    	<!--
         <tr>
         	<td>상품 : <input type="text" name="item"></td><br><br>
         	<td>주문자 : <input type="text" size="10" name="name"></td><br><br>
         	<td>가격 : <input type="text" size="5" name="price" ></td><br>
         </tr>
         -->
         <tr th:each="movieOrder : ${orderInfo}">
         	<td th:text="|${movieOrder.movie_nm}|"></td>
         	<td th:text="|${movieOrder.user_name}|"></td>
         	<td th:text="|${movieOrder.movie_sellPrice})|"></td>
         </tr>	
        <button id="iamportPayment" type="button">영화 구매</button>
    </div>
</th:block>
<script th:inline="javascript">
    $(document).ready(function() {
        $("#iamportPayment").click(function() {
        payment(); // 버튼 클릭시 호출    
        });
    });
    // 버튼 클릭하면 실행
	function payment(data) {
    	var IMP = window.IMP;    
   	 	IMP.init('imp53699217'); // 아임포트 관리자 콘솔에서 확인한 '가맹점 식별코드' 입력
   	 	var movieOrder = [[${movieOrder}]]
    	IMP.request_pay({ // param
        	pg : "kakaopay.TC0ONETIME", // pg사명 or pg사명.CID(잘못 입력한 경우, 기본 PG사가 띄워짐)
        	pay_method = "card",
        	merchant_uid = movieOrder.id, // 주문 번호
        	name : movieOrder.movie_nm, // 영화명
        	amount : movieOrder.movie_sellPrice, // 가격
        	buyer_email : "dahbs157@hanmail.net",
        	buyer_name : movieOrder.user_name, // 주문자
        	buyer_tel : "010-7158-8434", 
        	buyer_tel : memberPhone
    }, function(rsp) { // callback
        if(rsp.success) {
            var msg = "결제가 완료되었습니다.";
            msg = "고유 ID : " + rsp.imp_uid;
            msg = "상점 거래 ID : " + rsp.merchant_uid;
            msg = "결제 금액 : " + rsp.paid_amount;
            msg = "카드 승인번호 : " + rsp.apply_num;
            // jQuery로 HTTP 요청
            jQuery.ajax({
                url: "localhost:8383/movie/moviePaySuccess", // 가맹점 서버
                method : "POST",
                headers: { "Content-Type" : "application/json" },
                data: {
                    imp_uid : rsp.imp_uid,
                    merchant_uid : rsp.merchant_uid
                }
            }).done(function (data) {
                // 가맹점 서버 결제 API 성공시 로직
            })
        } else {
            // 결제 실패
            alert("결제에 실패하였습니다. 에러 내용: " +  rsp.error_msg);
            // jQuery로 HTTP 요청
            jQuery.ajax({
                url: "localhost:8383/movie/moviePayFail", // 가맹점 서버
                method : "POST",
                data: {
                    id : movieOrder.id
                }
            }).done(function (data) {
                // 가맹점 서버 결제 API 성공시 로직
            })
        }
    });

</script>    
</body>
=======
<meta charset="UTF-8">
<title>Insert title here</title>
<!-- jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
<!-- iamport.payment.js -->
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>
	<form name="movieBuy" action="####" method="post">
		<div class="full_collum collum">
			<ul>
                 <li class="collum_tit">
                 	<h2>영화 대여 정보</h2>
              		<ul>
                       	<li>
                           	<table class="board_basic_view">
                           		<tbody>
                           			<tr display="none">
                           				<td><input type="hidden" name="user_id" th:value="${sessionvo.user_id}"></td>
                           			</tr>
                           			<tr>
                           				<td><img th:src="'https://image.tmdb.org/t/p/w185' + ${movieVO.movie_iUrl}"></td>
                           			</tr>
                           			<tr>
                           				<th>영화번호</th>
                           				<td><input type="hidden" name="movie_koficCd" th:value="${movieVO.movie_koficCd}">[[${movieVO.movie_koficCd}]]</td>
                           			</tr>
                           			<tr>
                           				<th>영화명</th>
                           				<td><input type="hidden" name="movie_nm" th:value="${movieVO.movie_nm}">[[${movieVO.movie_nm}]]</td>
                           			</tr>
                           			<tr>
                            			<th>구매가격</th>
                            			<td><input type="hidden" name="movie_sellPrice" th:value="${movieVO.movie_sellPrice}">[[${movieVO.movie_sellPrice}]]원</td>
                            		</tr>
                            	</tbody>
                        	</table>
                        	<div class="btn_area">
                        		<a class="rent" th:onclick="|requestPay()|">구매하기</a>
                        		<a th:href="@{/movie/movieDetail(movie_koficCd=${movieVO.movie_koficCd})}" class="cancel">취소</a>
                        	</div>
                    	</li>
                 	</ul>
                 </li>
			</ul>
		</div>
	</form>
</body>
<script>
	var IMP = window.IMP; // 생략 가능
	IMP.init("imp91735831");
	
	function requestPay() {
      // IMP.request_pay(param, callback) 결제창 호출
      IMP.request_pay({ // param
          pg: "kakaopay.TC0ONETIME",
          pay_method: "card",
          merchant_uid: "merchant_" + new Date().getTime(),
          name: '[[${movieVO.movie_koficCd}]]',
          custom_data: '[[${movieVO.movie_nm}]]',
          amount: '[[${movieVO.movie_sellPrice}]]',
          buyer_name: '[[${sessionvo.user_name}]]',
          buyer_tel: '[[${sessionvo.user_phone}]]',
          buyer_email: '[[${sessionvo.user_email}]]',
      }, function (rsp) { // callback
          if (rsp.success) { // 결제 성공 시: 결제 승인 또는 가상계좌 발급에 성공한 경우
        	  purchase();
            } else {
              alert("결제에 실패하였습니다. 에러 내용: " +  rsp.error_msg);
            }
          });
    }
	
	function purchase() {
		console.log("puchase 실행")
		
		document.movieBuy.action = "moviePurchase"
		document.movieBuy.submit();
	}
</script>
>>>>>>> 0530efc3aa58b36e586866fbbe70d5e17bc19d96
</html>