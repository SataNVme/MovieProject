<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!-- jQuery -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
        <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <th:block th:replace="~{/include/layout :: setContent( ~{:: .rent} ) }">
    <div class="rent">
    	<!--
         <tr>
         	<td>상품 : <input type="text" name="item"></td><br><br>
         	<td>주문자 : <input type="text" size="10" name="name"></td><br><br>
         	<td>가격 : <input type="text" size="5" name="price" ></td><br>
         </tr>
         -->
         <tr th:each="movieOrder : ${orderInfo}">
         	<td th:text="|${movieOrder.movie_nm}|"></td>
         	<td th:text="|${movieOrder.user_name}|"></td>
         	<td th:text="|${movieOrder.movie_rentPrice})|"></td>
         </tr>	
        <button id="iamportPayment" type="button">영화 대여</button>
    </div>
</th:block>
<script th:inline="javascript">
    $(document).ready(function() {
        $("#iamportPayment").click(function() {
        payment(); // 버튼 클릭시 호출    
        });
    });
    // 버튼 클릭하면 실행
	function payment(data) {
    	var IMP = window.IMP;    
   	 	IMP.init('imp53699217'); // 아임포트 관리자 콘솔에서 확인한 '가맹점 식별코드' 입력
   	 	var movieOrder = [[${movieOrder}]]
    	IMP.request_pay({ // param
        	pg : "kakaopay.TC0ONETIME", // pg사명 or pg사명.CID(잘못 입력한 경우, 기본 PG사가 띄워짐)
        	pay_method = "card",
        	merchant_uid = movieOrder.id, // 주문 번호
        	name : movieOrder.movie_nm, // 영화명
        	amount : movieOrder.movie_rentPrice, // 가격
        	buyer_email : "dahbs157@hanmail.net",
        	buyer_name : movieOrder.user_name, // 주문자
        	buyer_tel : "010-7158-8434", 
        	buyer_tel : memberPhone
    }, function(rsp) { // callback
        if(rsp.success) {
            var msg = "결제가 완료되었습니다.";
            msg = "고유 ID : " + rsp.imp_uid;
            msg = "상점 거래 ID : " + rsp.merchant_uid;
            msg = "결제 금액 : " + rsp.paid_amount;
            msg = "카드 승인번호 : " + rsp.apply_num;
            // jQuery로 HTTP 요청
            jQuery.ajax({
                url: "localhost:8383/movie/moviePaySuccess", // 가맹점 서버
                method : "POST",
                headers: { "Content-Type" : "application/json" },
                data: {
                    imp_uid : rsp.imp_uid,
                    merchant_uid : rsp.merchant_uid
                }
            }).done(function (data) {
                // 가맹점 서버 결제 API 성공시 로직
            })
        } else {
            // 결제 실패
            alert("결제에 실패하였습니다. 에러 내용: " +  rsp.error_msg);
            // jQuery로 HTTP 요청
            jQuery.ajax({
                url: "localhost:8383/movie/moviePayFail", // 가맹점 서버
                method : "POST",
                data: {
                    id : movieOrder.id
                }
            }).done(function (data) {
                // 가맹점 서버 결제 API 성공시 로직
            })
        }
    });

</script>    
</body>
</html>